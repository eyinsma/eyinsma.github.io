---
layout: post
category : tech 
tags : [tech, socket]
description: |
  select() 后门.
---

##还在用select么
###开始
select()经常作为deMultiplex的分发者，也是refactor模式的重要部分，在编程中会经常遇到，当然java io 编程是不会直接touch到这一部分的。

这个问题来源于我们的一段JNI的c代码，主要是做sctp的socket编程的，这段JNI代码是在weblogic容器里面调用。现象是在weblogic容器里面这段c代码表现异常，甚至导致jvm crash。

###select()
标准的select的定义是这样的

	int select(int nfds, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timeval *timeout);

其中 nfds: 是所有监控fd中值最大的那个值+1，注意是值而不是fd的个数。    

为了操作方便，系统还提供了一系列的宏操作fd，比如:
	
	void FD_ZERO(fd_set *fdset);
	void FD_SET(int fd, fd_set *fdset);
	void FD_CLR(int fd, fd_set *fdset);
	int FD_ISSET(int fd, fd_set *fdset);

dd

	fd_set fds[MAX_FD_NUM];
	struct timeval tv;

		while(res == 0) {
		logSctpImpl("Selecting on: ", impl);
		
		tv.tv_sec = 60;
		tv.tv_usec = 0;

		for(int i=0; i<MAX_FD_NUM; i++)
		    FD_ZERO(&fds[i]);

		FD_SET(socket_fd_array_index, &fds[socket_fd_array_number]);
		FD_SET(closepipe_fd_array_index, &fds[closepipe_fd_array_number]);
		
		if(!FD_ISSET(socket_fd_array_index, &fds[socket_fd_array_number])) {
			logSctpImpl("\tsocket not set for select", impl);
		}
		
		int fdmax = impl->socket > impl->closepipe[0] ? impl->socket : impl->closepipe[0];
		res = select(fdmax + 1, &fds[0], NULL, NULL, &tv);
		}


#x
